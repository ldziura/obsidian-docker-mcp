# Obsidian MCP Remote Access Configuration

**For Claude Code and Claude Desktop on any Tailscale-connected machine**

---

## Architecture Overview

Your existing setup already has everything needed for remote MCP access:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Your Laptop / Desktop                           │
│                    (Any machine on Tailscale network)                   │
│                                                                         │
│  ┌─────────────────┐    stdio     ┌──────────────────────────────────┐  │
│  │   Claude Code   │◄────────────►│   mcp-obsidian (runs locally)    │  │
│  │  or Claude.ai   │              │   Points to remote REST API      │  │
│  └─────────────────┘              └──────────────┬───────────────────┘  │
│                                                  │                      │
└──────────────────────────────────────────────────┼──────────────────────┘
                                                   │
                                    HTTPS over Tailscale
                                                   │
                                                   ▼
┌────────────────────────────────────────────────────────────────────────┐
│                        Docker Host (Windows)                           │
│                                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     obsidian-docker stack                       │   │
│  │                                                                 │   │
│  │  ┌───────────────┐     ┌───────────────┐     ┌──────────────┐   │   │
│  │  │   Tailscale   │◄───►│     Caddy     │◄───►│   Obsidian   │   │   │
│  │  │  100.x.y.z    │     │  HTTPS proxy  │     │  REST API    │   │   │
│  │  └───────────────┘     └───────────────┘     │  Port 27124  │   │   │
│  │                                              │              │   │   │
│  │  obsidian-api.lucasdziura.art ─────────────► │  /vault/     │   │   │
│  │                                              └──────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
```

**Key insight:** The MCP server runs locally on each client machine, but connects to the remote Obsidian REST API over Tailscale. This means:
- No need to expose MCP server ports
- Full security via Tailscale encryption
- Same configuration works on any device

---

## Prerequisites

### On the Docker Host (already done)
- [x] Obsidian Docker running with Local REST API plugin
- [x] REST API exposed on port 27124
- [x] Caddy proxying to `obsidian-api.lucasdziura.art`
- [x] Tailscale connected

### On Each Client Machine
- [ ] Tailscale installed and connected to your network
- [ ] Python 3.10+ with `uv` package manager (for `uvx`)
- [ ] Claude Code installed (for CLI) or Claude Desktop

### Verify REST API is Accessible

From any Tailscale-connected machine:

```bash
# Test REST API connectivity (replace API_KEY with your key)
curl -H "Authorization: Bearer YOUR_API_KEY" \
     https://obsidian-api.lucasdziura.art/vault/

# Expected: JSON listing of vault root files
```

If this fails, check:
1. You're connected to Tailscale (`tailscale status`)
2. DNS resolves correctly (`nslookup obsidian-api.lucasdziura.art`)
3. Local REST API plugin is enabled in Obsidian

---

## Get Your API Key

The API key is generated by the Local REST API plugin in Obsidian:

1. Open Obsidian web UI: `https://obsidian.lucasdziura.art`
2. Go to **Settings → Community Plugins → Local REST API**
3. Copy the **API Key** shown (or generate a new one)
4. **Important:** Enable "Bind to all network interfaces" (set to `0.0.0.0`)

---

## Claude Code Configuration

### Option 1: Project-Level Configuration (Recommended)

Create `.mcp.json` in your project root:

```json
{
  "mcpServers": {
    "obsidian": {
      "command": "uvx",
      "args": ["mcp-obsidian"],
      "env": {
        "OBSIDIAN_API_KEY": "YOUR_API_KEY_HERE",
        "OBSIDIAN_HOST": "obsidian-api.lucasdziura.art",
        "OBSIDIAN_PORT": "443",
        "OBSIDIAN_HTTPS": "true"
      }
    }
  }
}
```

This configuration:
- Uses HTTPS (port 443) via Caddy
- Automatically available when working in this project
- Can be committed to git (consider using environment variables for the API key)

### Option 2: User-Level Configuration (All Projects)

Add to `~/.claude.json` (create if doesn't exist):

```json
{
  "mcpServers": {
    "obsidian": {
      "command": "uvx",
      "args": ["mcp-obsidian"],
      "env": {
        "OBSIDIAN_API_KEY": "YOUR_API_KEY_HERE",
        "OBSIDIAN_HOST": "obsidian-api.lucasdziura.art",
        "OBSIDIAN_PORT": "443",
        "OBSIDIAN_HTTPS": "true"
      }
    }
  }
}
```

### Option 3: CLI Command

```bash
# Add MCP server via CLI
claude mcp add obsidian \
  --command "uvx" \
  --args "mcp-obsidian" \
  --env "OBSIDIAN_API_KEY=YOUR_API_KEY" \
  --env "OBSIDIAN_HOST=obsidian-api.lucasdziura.art" \
  --env "OBSIDIAN_PORT=443" \
  --env "OBSIDIAN_HTTPS=true" \
  --scope user
```

### Using Environment Variables (More Secure)

For better security, use environment variables instead of hardcoding the API key:

**.mcp.json:**
```json
{
  "mcpServers": {
    "obsidian": {
      "command": "uvx",
      "args": ["mcp-obsidian"],
      "env": {
        "OBSIDIAN_API_KEY": "${OBSIDIAN_API_KEY}",
        "OBSIDIAN_HOST": "obsidian-api.lucasdziura.art",
        "OBSIDIAN_PORT": "443",
        "OBSIDIAN_HTTPS": "true"
      }
    }
  }
}
```

Then set the environment variable:

```bash
# Linux/macOS - add to ~/.bashrc or ~/.zshrc
export OBSIDIAN_API_KEY="your_api_key_here"

# Windows PowerShell - add to $PROFILE
$env:OBSIDIAN_API_KEY = "your_api_key_here"

# Or set system-wide in Windows
[System.Environment]::SetEnvironmentVariable('OBSIDIAN_API_KEY', 'your_api_key_here', 'User')
```

---

## Claude Desktop Configuration

Edit `claude_desktop_config.json`:

**Windows:** `%APPDATA%\Claude\claude_desktop_config.json`
**macOS:** `~/Library/Application Support/Claude/claude_desktop_config.json`
**Linux:** `~/.config/Claude/claude_desktop_config.json`

```json
{
  "mcpServers": {
    "obsidian": {
      "command": "uvx",
      "args": ["mcp-obsidian"],
      "env": {
        "OBSIDIAN_API_KEY": "YOUR_API_KEY_HERE",
        "OBSIDIAN_HOST": "obsidian-api.lucasdziura.art",
        "OBSIDIAN_PORT": "443",
        "OBSIDIAN_HTTPS": "true"
      }
    }
  }
}
```

**Restart Claude Desktop** after saving the configuration.

---

## Available MCP Tools

Once connected, Claude has access to these Obsidian tools:

| Tool | Description |
|------|-------------|
| `list_files_in_vault` | List all files in the vault |
| `list_files_in_dir` | List files in a specific directory |
| `get_file_contents` | Read a note's content |
| `simple_search` | Search vault by text |
| `append_content` | Add content to end of a note |
| `patch_content` | Insert content at specific location |
| `delete_file` | Delete a note (use with caution) |

### Example Usage in Claude Code

```
/mcp

# Then you can ask:
"List all my daily notes"
"Search for notes about Japanese learning"
"Read the contents of 01_Projects/widget-framework.md"
"Add a new task to today's daily note"
```

---

## Verify MCP Connection

### In Claude Code

```bash
# Start Claude Code
claude

# Check MCP server status
/mcp

# You should see "obsidian" listed as connected
```

### Test Commands

Try these in Claude Code:

```
"Use the obsidian MCP to list files in the vault root"

"Search my Obsidian vault for notes about 'homelab'"

"Read my daily note from today"
```

---

## Alternative: cyanheads/obsidian-mcp-server

If you need advanced features like caching for large vaults:

```json
{
  "mcpServers": {
    "obsidian": {
      "command": "npx",
      "args": ["-y", "obsidian-mcp-server"],
      "env": {
        "OBSIDIAN_API_KEY": "YOUR_API_KEY_HERE",
        "OBSIDIAN_BASE_URL": "https://obsidian-api.lucasdziura.art"
      }
    }
  }
}
```

**Benefits over mcp-obsidian:**
- Vault caching (better performance on large vaults)
- More comprehensive search options
- Better error handling

**Tradeoff:**
- Requires Node.js/npm instead of Python/uv

---

## Troubleshooting

### "Connection refused" or "timeout"

1. **Check Tailscale connection:**
   ```bash
   tailscale status
   # Should show "obsidian-docker" in the list
   ```

2. **Test DNS resolution:**
   ```bash
   nslookup obsidian-api.lucasdziura.art
   # Should return your Tailscale IP
   ```

3. **Test REST API directly:**
   ```bash
   curl -v -H "Authorization: Bearer YOUR_API_KEY" \
        https://obsidian-api.lucasdziura.art/vault/
   ```

### "401 Unauthorized"

- API key is incorrect
- Regenerate key in Obsidian: Settings → Local REST API → Generate New Key
- Update key in your MCP configuration

### "HTTPS certificate error"

The Caddy reverse proxy should provide valid HTTPS. If you see certificate errors:

```bash
# Check Caddy logs on Docker host
docker logs obsidian-caddy

# Verify certificate
openssl s_client -connect obsidian-api.lucasdziura.art:443 -servername obsidian-api.lucasdziura.art
```

### MCP Server Not Starting

1. **Ensure uv/uvx is installed:**
   ```bash
   # Install uv (Python package manager)
   curl -LsSf https://astral.sh/uv/install.sh | sh
   
   # Or on Windows
   powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"
   
   # Verify
   uvx --version
   ```

2. **Test MCP server manually:**
   ```bash
   OBSIDIAN_API_KEY="your_key" \
   OBSIDIAN_HOST="obsidian-api.lucasdziura.art" \
   OBSIDIAN_PORT="443" \
   OBSIDIAN_HTTPS="true" \
   uvx mcp-obsidian
   ```

### "Permission denied" on vault operations

- Check Local REST API plugin settings in Obsidian
- Ensure "Enable write operations" is checked
- Some operations require confirmation in Obsidian UI

---

## Security Considerations

### What's Protected

1. **Network Layer:** All traffic encrypted via Tailscale (WireGuard)
2. **Application Layer:** HTTPS encryption via Caddy
3. **Authentication:** API key required for all requests
4. **Access Control:** Only Tailscale network members can reach the endpoint

### Best Practices

1. **Rotate API key periodically** - regenerate in Obsidian settings
2. **Use environment variables** - don't commit API keys to git
3. **Monitor access** - check Caddy logs for unusual patterns
4. **Limit Tailscale ACLs** - restrict which devices can access the API endpoint

### Tailscale ACL Example

Add to your Tailscale ACLs for additional security:

```json
{
  "acls": [
    {
      "action": "accept",
      "src": ["tag:trusted-devices"],
      "dst": ["obsidian-docker:443"]
    }
  ]
}
```

---

## Quick Reference

| Item | Value |
|------|-------|
| REST API Endpoint | `https://obsidian-api.lucasdziura.art` |
| MCP Server Package | `mcp-obsidian` (via uvx) |
| Required Env Vars | `OBSIDIAN_API_KEY`, `OBSIDIAN_HOST`, `OBSIDIAN_PORT`, `OBSIDIAN_HTTPS` |
| Claude Code Config | `~/.claude.json` or `.mcp.json` |
| Claude Desktop Config | `%APPDATA%\Claude\claude_desktop_config.json` |

---

## Complete Setup Checklist

### On Docker Host (one-time)
- [ ] Local REST API plugin installed and enabled
- [ ] "Bind to all interfaces" enabled in plugin settings
- [ ] API key generated and saved
- [ ] Port 27124 exposed in docker-compose.yml
- [ ] Caddy configured for `obsidian-api.lucasdziura.art`

### On Each Client Machine
- [ ] Tailscale installed and connected
- [ ] `uv` package manager installed
- [ ] MCP configuration added (Claude Code or Claude Desktop)
- [ ] Environment variable set for API key (optional but recommended)
- [ ] Connection verified with test query
